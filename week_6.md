# 6-1 intro
![](images/wee6_01.png)

# 6-2 가독성을 챙기기 위한 SQL 스타일 가이드
데이터 결과 검증을 하기 전에

실수는 언제 발생하는가?
다른 사람의 쿼리를 봐야하는 경우 또는 내 쿼리를 다른 사람이 보는 경우
쿼리 가독성 있으면 설명 없어도 ㄱㅊ
쿼리 변경시 뭐 바꾸었는지 적어야 함. (특정부분만 바꿨는지, 전체 바꿨는지)

예약어는 대문자로 작성
SQL에서 문법적인 용도로 사용하고 있는 문자들은 대문자로 작성
예약어의 대표적인 예시: SELECT, FROM, WEHRE 각종 함수

컬럼 이름은 snake_case로 작성
컬럼의 이름은 snake_case로 작성
단 회사의 기준이 camelcase 면 사용. 일관성이 중요!

명시적 vs 암시적인 이름
Alias로 별칭을 지을 때는 명시적인 이름을 적용
AS a, AS b 등 컬럼의 의미를 한번 더 생각하게 하는 이름이 아닌 명시적인 것을 사용
JOIN할 때 테이블의 이름도 명시적으로 할 수 있다면 명시적으로 진행
AS를 생략해서 별칭을 설정할 수도 있는데, AS를 쓰는 것도 명시적인 표현

왼쪽정렬
기본적으로 왼쪽정렬 함.

예약어나 컬럼은 한줄에 한줄씩
컬럼은 바로 주석처리할 수 있는 장점, 한 줄에 하나씩 작성

쉼표는 컬럼 바로 뒤에
의견이 갈리는 부분 (쉼표 앞 vs 뒤)
big query는 마지막 쉼표를 무시해서 뒤로 작성해도 무방

# 6-3 가독성을 챙기기 위한 with문 & 파티션

sql 쿼리 작성하다 생기는 일: 가독성이 낮아짐. 점점복잡해짐
만약 아래 쿼리가 다른 곳에서도 필요하면 복사 붙여넣기

wirh 문 사용해 쿼리 정의해서 재사용 가능!!
![](images/wee6_02.png)

With 구문
CTE(common table expression)
SELECT구문에 이름을 정해주는 것과 유사
쿼리 내에서 반복적으로 쓸 수 있음

With 구문 사용 방법
![](images/wee6_03.png)

PARTITION
table엔 partition이란 것이 존재할 수 있음

창고에 수많은 물건이 매일 들어옴
특정 시기 들어온 물건 찾고싶으면?
애초에 일자별로 정리하기

PARTITION을 사용하면 좋은 점
쿼리 성능 향상
전체 데이터를 스캔하는 것보다 파티션을 설정한 곳만 스캔하는 것이 더 빠름

데이터 관리 용이성
특정 일자의 데이터를 모두 변경하거나 삭제해야 하면 파티션을 설정해서 삭제할 수 있음

비용
파티션에 해당하는 데이터만 스캔해서 비용을 줄일 수 있음
(big query는 쿼리 용량에 비례해서 과금)

# 6-4 데이터 결과 검증 정의
데이터 결과 검증 내용 다루는 곳 거의 없음. 여기서 잘 배워가기!!

데이터 결과 검증의 정의
SQL 쿼리 얻은 결과가 예상과 일치하는지 확인하는 과정
목적: 분석 결과의 정확성, 신뢰성 확보
방법
기대하는 예상 결과 정의
쿼리 작성
두개가 일치하는지 비교

제일 중요한 부분
문제를 잘 정의하고 미리 작성
도메인 특수성(이런 규칙 등) 잘 파악하기
SQL 쿼리 템플릿과 맥락이 유사

데이터 결과 검증 흐름
![](images/wee6_04.png)

데이터 결과 검증할 때 자주 활용하는 SQL쿼리

1) count(*): 행수를 확인, 의도한 데이터의 행 개수가 맞는가
2) not null: 특정 컬럼에 null이 존재하는가? 필수 필드가 비어있지 않은가?
3) distinct: 데이터의 고유값을 확인해 중복 여부 확인, count(distinct 컬럼)=count(컬럼)
if문, case when: 의도와 같다면 true, 아니면 false

1)+3) SELECT COUNT(DISTINCT col), COUNT(col) 두 컬럼을 보고 개수를 비교

데이터 결과 검증시 활용법
1) 특정 user_id로 필터링을 걸어서 확인하기
- 1명의 데이터 확인
- 결과를 예상할 떄 raw데이터에서 하나씩 눈으로 세고 적어둠
- 1명이 데이터의 예상 결과과 쿼리 결과가 동일한지 확인
- 다른 user_id 3-4건 추가해서 확인
- 3-4개에서 동일한 결과가 나오면 user_id 조건을 삭제

2) 샘플 데이터 생성하기
with문을 사용해 예시 데이터를 생성한 후, 결과를 예상하고 쿼리 작성
복잡한 데이터에서 하기 전에, 쿼리 자체가 올바른지 확인할 때 주로 사용

# 6-5. 데이터 결과 검증 예시

예시문제
포켓몬 트레이너 배틀성적 분석작업
각 트레이너 진행 배틀 승리비율 계산, 배틀에 참여한 횟수가 9회 이상인 경우만 계산

검증 프로세스 흐름
![](images/wee6_05.png)

특정 유저 아이디 선정
특정 유저 아이디 선정.여기에선 임의로 선정
테이블 다시 확인해보기

쿼리작성
트레이너가 승리한 비율 구하기
트레이너가 참여한 배틀의 수 구하기
트레이너가 승리한 배틀의 수 구하기
두개 조합해서 승리한 비율 구할 수 있음
단 이 쿼리를 어떻게 해야할까?
배틀의 수가 9 이상만 추출

통합 데이터 생성(player1,2 구분을 하지 않아도 되는 테이블 -> trainer_id 생성)
![](images/wee6_06.png)

트레이너 아이디 = 7 의 총 배틀횟수 구하는 쿼리
트레이너 아이디, 위너 아이디 조합하여 이김, 짐, 무승부 만들어보기
countif 사용해 값 구하기

특정 유저 조건 제외
where 의 트레이너 아이디 제거후, 배틀횟수 9 이상 조건으로 넣기

# 6-6. 정리
다양한 검증 방법과 예시 쿼리를 볼 수 있어 좋았다!!

![](images/wee6_07.png)